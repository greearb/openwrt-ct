#!/bin/ash

[ "$ACTION" == "add" ] || exit 0

PHYNBR=${DEVPATH##*/phy}

[ -n $PHYNBR ] || exit 0

. /lib/functions.sh
. /lib/functions/system.sh

board=$(board_name)

case "$board" in
	linksys,ea8500)
		echo $(macaddr_add $(mtd_get_mac_ascii devinfo hw_mac_addr) $(($PHYNBR + 1)) ) > /sys${DEVPATH}/macaddress
		;;
	nec,wg2600hp)
		echo $(macaddr_add $(mtd_get_mac_binary PRODUCTDATA 12) $((1 - $PHYNBR)) ) > /sys${DEVPATH}/macaddress
		;;
	tplink,c2600)
		echo $(macaddr_add $(mtd_get_mac_binary default-mac 8)  $(($PHYNBR - 1)) ) > /sys${DEVPATH}/macaddress
		;;
	tplink,vr2600v)
		echo $(macaddr_add $(mtd_get_mac_binary default-mac 0)  $(($PHYNBR - 1)) ) > /sys${DEVPATH}/macaddress
		;;
	zyxel,nbg6817)
		echo $(macaddr_add $(mtd_get_mac_ascii 0:APPSBLENV ethaddr) $((1 - $PHYNBR)) ) > /sys${DEVPATH}/macaddress
		;;
	*)
		;;
esac

OPATH=${DEVPATH##/devices/platform/}
OPATH=${OPATH%%/ieee*}

# For USB, OPATH looks like this at this point in this script:
# soc/soc:usb30@0/11000000.dwc3/xhci-hcd.0.auto/usb1/1-1/1-1:1.0
# But, the uci path has a platform/ prefix on that:
# platform/soc/soc:usb30@0/11000000.dwc3/xhci-hcd.0.auto/usb1/1-1/1-1:1.0
OPATH_USB="platform/$OPATH";

# 10 radios is enough for anyone!
#echo "fix-wifi-mac, OPATH: $OPATH" >> /tmp/foo.txt
for i in `seq 0 9`;
  do
  BUS=`uci get wireless.@wifi-device[$i].path`
  #echo "fix-wifi-mac, BUS[$i]: $BUS" >> /tmp/foo.txt
  if [ "$BUS " == "$OPATH " ] || [ "$BUS " == "$OPATH_USB " ]
      then
      PHYNAME=${DEVPATH##*ieee80211/}
      NPHYNAME=`uci get wireless.@wifi-device[$i].phyname`
      #echo "fix-wifi-mac, PHYNAME[$i]: $PHYNAME  NPHYNAME: $NPHYNAME" >> /tmp/foo.txt;
      if [ "$NPHYNAME " != " " ]
          then
          if [ "$PHYNAME " != "$NPHYNAME " ]
              then
	      #echo "fix-wifi-mac, renaming..." >> /tmp/foo.txt;
              iw $PHYNAME set name $NPHYNAME
          fi
      fi
  fi
done
